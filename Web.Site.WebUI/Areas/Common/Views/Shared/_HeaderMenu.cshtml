<header class="lyear-layout-header">
    <nav class="navbar navbar-default">
        <div class="topbar">

            <div class="topbar-left">
                <div class="lyear-aside-toggler">
                    <span class="lyear-toggler-bar"></span>
                    <span class="lyear-toggler-bar"></span>
                    <span class="lyear-toggler-bar"></span>
                </div>
                <span class="navbar-page-title" id="clock" />
            </div>

            <ul class="topbar-right">
                <li class="dropdown dropdown-profile">
                    <a href="javascript:void(0)" data-toggle="dropdown">
                        <img class="img-avatar img-avatar-48 m-r-10" id="header-userName-alt" src="~/image/main/userProfile.jpg" />
                        <span id="header-userName"> </span></span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-right">
                        <li> <a href="@Url.Action("SetUserProfile", "Dashboard", new { Area = "Common" })"><i class="mdi mdi-account"></i> 个人信息</a> </li>
                        <li> <a href="#" onclick="OpenChangePwdModal()"><i class="mdi mdi-lock-outline"></i> 修改密码</a> </li>
                        <li class="divider"></li>
                        <li> <a href="@Url.Action("SignOut", "Login", new { Area = "Common" })"><i class="mdi mdi-logout-variant"></i> 退出登录</a> </li>
                    </ul>
                </li>
            </ul>

        </div>
    </nav>
    <div class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="ChangePwdModalLabel" id="ChangePwdModal">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                    <h4 class="modal-title" id="myLargeModalLabel">修改用户密码</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group has-feedback feedback-left">
                        <input type="password" placeholder="请输入原密码" class="form-control" id="oldPassword" />
                        <span class="mdi mdi-lock form-control-feedback" aria-hidden="true"></span>
                    </div>
                    <div class="form-group has-feedback feedback-left">
                        <input type="password" placeholder="请输入新密码" class="form-control" id="newPassword" />
                        <span class="mdi mdi-lock form-control-feedback" aria-hidden="true"></span>
                    </div>
                    <div class="form-group has-feedback feedback-left">
                        <input type="password" placeholder="请再次输入新密码" class="form-control" id="newDPassword" />
                        <span class="mdi mdi-lock form-control-feedback" aria-hidden="true"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button class="btn btn-label btn-danger" onclick="ChangePwd()"><label><i class="mdi mdi-close"></i></label> 修改密码</button>
                </div>
            </div>
        </div>
    </div>
</header>
<script src="~/Scripts/new/md5.js"></script>
<script>
    var attime;
    function clock() {
        var time = new Date();
        attime = time.toLocaleString();
        document.getElementById("clock").innerText = attime;
    }
    setInterval(clock, 1000);

    function getUserName() {
        var userName = getCookiesByName('LoginName');
        if (userName && userName != "") {
            document.getElementById("header-userName").innerHTML = userName + '<span class="caret">';
            document.getElementById("header-userName-alt").innerText = userName;
        }
        else {
            window.location.href = "@Url.Action("index", "Account", new { Area = "Common" })";
        }
    }
    function OpenChangePwdModal() {
        $('#ChangePwdModal').modal('show');
        $('#oldPassword').val('');
        $('#newPassword').val('');
        $('#newDPassword').val('');
    }
    function ChangePwd() {
        lightyear.loading('show');
        let oldLoginPwd = $('#oldPassword').val();
        let newLoginPwd = $('#newPassword').val();
        let newDLoginPwd = $('#newDPassword').val();
        if (newLoginPwd === newDLoginPwd) {
            setTimeout(function () { lightyear.loading('hide'); lightyear.notify('新密码两次输入不一致', 'warning'); }, 1e3);
            return;
        }
        if (newLoginPwd.length < 6 || newLoginPwd.length > 20) {
            setTimeout(function () { lightyear.loading('hide'); lightyear.notify('新密码需要长度大于6位小于20位', 'warning'); }, 1e3);
            return;
        }
        if (newLoginPwd == oldLoginPwd) {
            setTimeout(function () { lightyear.loading('hide'); lightyear.notify('新旧密码一致', 'warning'); }, 1e3);
            return;
        }
        oldLoginPwd = hex_md5(oldLoginPwd);
        newLoginPwd = hex_md5(newLoginPwd);
        var actionUrl = "@Url.Action("ChangePwd", "Account")";
        var formData = { LoginPwd: oldLoginPwd, NewLoginPwd: newLoginPwd };
        $.ajax({
                    type: 'post',
                    url: actionUrl,
                    data: formData,
                    success: function (result) {
                        if (result.IsSuccess) {
                            $('#ChangePwdModal').modal('hide');
                            setTimeout(function () { lightyear.loading('hide'); lightyear.notify('密码修改成功！', 'success'); }, 1e3);
                        } else {
                            setTimeout(function () { lightyear.loading('hide'); lightyear.notify(result.Result, 'danger'); }, 1e3);
                            $('#oldPassword').val('');
                            $('#newPassword').val('');
                            $('#newDPassword').val('');
                        }
                    }
                });
    }

    function getCookiesByName(name) {
        var arr;
        if (arr = document.cookie.match("pubser_loginuserkey")) {
            var obj = arr['input'];
            var index = obj.lastIndexOf("=");
            obj = obj.substring(index + 1, obj.length);
            var cookies = JSON.parse(obj);
            return cookies[name];
        }
        return null;
    }
    getUserName();
    setInterval(getUserName, 60*1000);
</script>